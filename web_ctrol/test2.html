<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .slidecontainer {
            width: 100%;
            padding: 20px;
        }
        #connectionStatus {
            font-weight: bold;
            margin-bottom: 15px;
        }
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 25px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
            margin-bottom: 15px;
            border-radius: 12px;
        }
        .slider:hover {
            opacity: 1;
        }
        .slider::-webkit-slider-thumb,
        .slider::-moz-range-thumb {
            -webkit-appearance: none;
            width: 35px;
            height: 35px;
            background: #04AA6D;
            cursor: pointer;
            border-radius: 50%;
        }
        .slider-value {
            margin-left: 10px;
            font-weight: bold;
            color: #04AA6D;
            font-size: 1.2em;
        }
        .Time-select, .Step-select {
            margin-bottom: 20px;
            padding: 8px;
            font-size: 1.1em;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin-right: 10px;
        }
        .add-button {
            background-color: #04AA6D;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 5px;
            font-size: 1.1em;
        }
        .add-button:hover {
            background-color: #038857;
        }
        #exportButton {
            background-color: #04AA6D;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            margin-top: 10px;
        }
        #exportButton:hover {
            background-color: #038857;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-sm bg-secondary">
        <div class="container-fluid">
            <a class="navbar-brand text-white" href="#" style="font-size: 1.7rem; font-weight: bold;">I - Soft</a>
        </div>
    </nav>

    <div id="chartContainer" style="height: 370px; width: 100%;"></div>
    <div id="connectionStatus">Connecting...</div>

    <div class="container mt-4">
        <h3>Time Control</h3>
        <div class="slidecontainer">
            <select id="StepSelect" class="Step-select">
                <option value="0">Step 1</option>
                <option value="1">Step 2</option>
                <option value="2">Step 3</option>
                <option value="3">Step 4</option>
                <option value="4">Step 5</option>
                <option value="5">Step 6</option>
                <option value="6">Step 7</option>
                <option value="7">Step 8</option>
            </select>
            <button id="addStepButton" class="add-button">+</button>
        </div>

        <div class="slidecontainer">
            <select id="TimeSelect" class="Time-select">
                <option value="0">Time 1</option>
                <option value="1">Time 2</option>
                <option value="2">Time 3</option>
                <option value="3">Time 4</option>
                <option value="4">Time 5</option>
                <option value="5">Time 6</option>
                <option value="6">Time 7</option>
                <option value="7">Time 8</option>
                <option value="8">Time 9</option>
                <option value="9">Time 10</option>
            </select>
            <button id="addTimeButton" class="add-button">+</button>
        </div>

        <div class="slidecontainer">
            <label>Min Degree: <input type="number" id="minDegreeInput" value="0" step="0.1" style="width: 70px; margin-right: 10px;"></label>
            <label>Max Degree: <input type="number" id="maxDegreeInput" value="360" step="0.1" style="width: 70px;"></label>
            <label>Degree: <span id="sliderValue" class="slider-value">5</span></label>
            <input type="range" min="0" max="360" value="0" step="0.1" class="slider" id="mainSlider">
        </div>

        <button id="exportButton">Export Data to Terminal</button>
    </div>

    <script src="https://cdn.canvasjs.com/canvasjs.min.js"></script>
    <script>
    window.onload = function () {
        let stepCount = 8;
        let timeCount =10;
        // Initial data
        const initialData = {
            "Step 1": [2.22, 2.20, 2.44, 2.45, 2.58, 2.44, 2.40, 2.72, 2.66, 3.04],
            "Step 2": [3.86, 3.76, 3.77, 3.65, 3.90, 3.88, 3.69, 3.86, 3.38, 4.20],
            "Step 3": [4.37, 4.27, 4.72, 4.87, 5.35, 5.50, 4.84, 4.13, 5.22, 5.39],
            "Step 4": [6.64, 6.31, 6.59, 6.95, 7.16, 6.40, 7.20, 7.17, 6.95, 7.09],
            "Step 5": [8.00, 6.81, 6.71, 6.82, 6.56, 6.24, 5.40, 7.01, 7.14, 8.11],
            "Step 6": [7.94, 7.29, 7.28, 7.82, 7.89, 6.71, 7.80, 7.60, 7.66, 8.89],
            "Step 7": [10.11, 9.27, 9.25, 10.17, 10.72, 10.24, 12.07, 7.60, 7.66, 8.89],
            "Step 8": [11.76, 10.29, 12.02, 11.80, 12.48, 13.61, 12.07, 7.60, 7.66, 8.89]
        };


        var chart = new CanvasJS.Chart("chartContainer", {
            theme: "light2",
            animationEnabled: true,
            title: {
                text: "Step Motor Times"
            },
            axisY: {
                title: "Number of Viewers",
                suffix: ""
            },
            axisX: {
                title: "Times",
                interval: 1
            },
            toolTip: {
                shared: true
            },
            legend: {
                cursor: "pointer",
                itemclick: toggleDataSeries
            },
            data: []
        });

        function updateChart() {
            chart.options.data = [];
            for (let i = 1; i <= stepCount; i++) {
                const StepData = initialData[`Step ${i}`] ? 
                    initialData[`Step ${i}`].slice(0, timeCount).map((value, index) => ({
                        label: `Time ${index + 1}`,
                        y: value
                    })) :
                    Array(timeCount).fill(0).map((_, index) => ({
                        label: `Time ${index + 1}`,
                        y: 5
                    }));

                chart.options.data.push({
                    type: "spline",
                    visible: true,
                    showInLegend: true,
                    name: `Step ${i}`,
                    dataPoints: StepData
                });
            }
            chart.render();
        }
        updateChart();
        const connectionStatus = document.getElementById('connectionStatus');
        // Controls
        const slider = document.getElementById("mainSlider");
        const sliderValue = document.getElementById("sliderValue");
        const TimeSelect = document.getElementById("TimeSelect");
        const StepSelect = document.getElementById("StepSelect");
        const exportButton = document.getElementById("exportButton"); 
        const addStepButton = document.getElementById("addStepButton"); 
        const addTimeButton = document.getElementById("addTimeButton"); 
        const minDegreeInput = document.getElementById("minDegreeInput");
        const maxDegreeInput = document.getElementById("maxDegreeInput");

        const socket = new WebSocket(`ws://192.168.0.109/ws`);
        socket.onopen = function(e) {
            connectionStatus.textContent = 'Connected';
            connectionStatus.style.color = 'green';
        };
        socket.onclose = function(event) {
            connectionStatus.textContent = 'Disconnected';
            connectionStatus.style.color = 'red';
        };
        socket.onerror = function(error) {
            console.error('WebSocket Error:', error);
            connectionStatus.textContent = 'Connection Error';
            connectionStatus.style.color = 'red';
        };


        // Hàm cập nhật giới hạn slider
        function updateSliderLimits() {
            const newMin = parseFloat(minDegreeInput.value);
            const newMax = parseFloat(maxDegreeInput.value);

            if (newMin < newMax) {
                slider.min = newMin;
                slider.max = newMax;
                    slider.value = newMin;
                    slider.value = newMax;
                sliderValue.textContent = parseFloat(slider.value).toFixed(2);
            } 
            
        }
        minDegreeInput.addEventListener("input", updateSliderLimits);
        maxDegreeInput.addEventListener("input", updateSliderLimits);


        ///button handler Step //
        
        addStepButton.addEventListener('click',function(){
            stepCount++;
            const option = document.createElement("option");
            option.value = stepCount - 1;
            option.text = `Step ${stepCount}`;
            StepSelect.add(option);
            initialData[`Step ${stepCount}`] = Array(timeCount).fill(5);
            updateChart();
        });
         ///button handler Time //
        addTimeButton.addEventListener('click', function() {
            timeCount++;
            const option = document.createElement("option");
            option.value = timeCount - 1;
            option.text = `Time ${timeCount}`;
            TimeSelect.add(option);
            // Add new time point to each step
            Object.keys(initialData).forEach(step => {
                initialData[step].push(5);
            });
            updateChart();
        });

        
        

        slider.oninput = function() {
            const value = parseFloat(this.value);
            sliderValue.textContent = value.toFixed(2);
            const selectedTime = parseInt(TimeSelect.value);
            const selectedStep = parseInt(StepSelect.value);

            // Update only the selected Step's Time
            chart.options.data[selectedStep].dataPoints[selectedTime].y = value;
            initialData[`Step ${selectedStep + 1}`][selectedTime] = value;
            chart.render();
        };

       ///onchange slider// 
        slider.onchange = function() {
            const value = parseFloat(this.value);
            const selectedTime = parseInt(TimeSelect.value);
            const selectedStep = parseInt(StepSelect.value);

            console.log(`Slider changed: Step ${selectedStep + 1}, Time ${selectedTime + 1}, Value: ${value.toFixed(2)}`);
        };

        function toggleDataSeries(e) {
            if (typeof(e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
                e.dataSeries.visible = false;
            } else {
                e.dataSeries.visible = true;
            }
            chart.render();
        }
                // Export button click handler
        exportButton.addEventListener('click', function() {
        const data = chart.options.data.map(series => ({
        Step: series.name,
        Times: series.dataPoints.map(point => point.y)
            }));
            
            console.log('Exported Data:');
            data.forEach(StepData => {
                console.log(`${StepData.Step}:`, StepData.Times);
            });
        });
    };
    </script>
</body>
</html>

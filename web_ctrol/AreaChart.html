<!DOCTYPE HTML>
<html lang="en">
<html>
<head>
    <title>Control MultiDriver Stepper Dashboard</title>
    <style>
        
        .navbar {
            background-color: #6c757d; 
            padding: 10px; 
        }

        .navbar-brand {
            font-size: 1.7rem;
            font-weight: bold;
            color: white;
        }
        #connectionStatus {
            font-weight: bold;
            margin-bottom: 15px;
        }
        .add-button {
            margin-left: 10px;
            background-color: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
        }
        .add-button:hover {
            background-color: #218838;
        }
        .slider {
            width: 100%;
            margin-top: 10px;
        }
        .slider-value {
            margin-left: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">I - Soft</a>
        </div>
    </nav>
    <div id="chartContainer" style="height: 370px; width: 100%;"></div>
    <div class="container mt-4">
        <div id="connectionStatus">Connecting...</div>
        <h3>Step Control</h3>
        <div class="slidecontainer">
            <select id="DeviceSelect" class="Device-select">
                <option value="0">Device 1</option>
                <option value="1">Device 2</option>
                <option value="2">Device 3</option>
                <option value="3">Device 4</option>
                <option value="4">Device 5</option>
                <option value="5">Device 6</option>
                <option value="6">Device 7</option>
                <option value="7">Device 8</option>
            </select>
            <button id = "addDeviceButton" class = "add-button">+</button>
        </div>
            <select id="StepSelect" class="Step-select">
                <option value="0">Step 1</option>
                <option value="1">Step 2</option>
                <option value="2">Step 3</option>
                <option value="3">Step 4</option>
                <option value="4">Step 5</option>
                <option value="5">Step 6</option>
                <option value="6">Step 7</option>
                <option value="7">Step 8</option>
                <option value="8">Step 9</option>
                <option value="9">Step 10</option>
            </select>
            <button id = "addStepButton" class = "add-button">+</button>
        </div>
            <div>
                <label>Min Degree: <input type="number" id="minDegreeInput" value="0" Device="0.1" style="width: 70px; margin-right: 10px;"></label>
                <label>Max Degree: <input type="number" id="maxDegreeInput" value="360" Device="0.1" style="width: 70px;"></label>
                <label>Degree: <span id="sliderValue" class="slider-value">5</span></label>
                <input type="range" min="0" max="360" value="0" Device="0.1" class="slider" id="mainSlider">
            </div>
            <button id="exportButton">Export Data to Terminal</button> 
        </div>
    </div>
    <footer class="bg-dark text-white text-center py-3 mt-4">
    </footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.min.js"></script>
    <script src="https://cdn.canvasjs.com/canvasjs.min.js"></script>
    
    <script>
    window.onload = function () {
        let DeviceCount = 8;
        let StepCount =10;

        // Initial data for Devices
        const initialData = {
            "Device 1": [2.22, 2.20, 2.44, 2.45, 2.58, 2.44, 2.40, 2.72, 2.66, 3.04],
            "Device 2": [3.86, 3.76, 3.77, 3.65, 3.90, 3.88, 3.69, 3.86, 3.38, 4.20],
            "Device 3": [4.37, 4.27, 4.72, 4.87, 5.35, 5.50, 4.84, 4.13, 5.22, 5.39],
            "Device 4": [6.64, 6.31, 6.59, 6.95, 7.16, 6.40, 7.20, 7.17, 6.95, 7.09],
            "Device 5": [8.00, 6.81, 6.71, 6.82, 6.56, 6.24, 5.40, 7.01, 7.14, 8.11],
            "Device 6": [7.94, 7.29, 7.28, 7.82, 7.89, 6.71, 7.80, 7.60, 7.66, 8.89],
            "Device 7": [10.11, 9.27, 9.25, 10.17, 10.72, 10.24, 12.07, 7.60, 7.66, 8.89],
            "Device 8": [11.76, 10.29, 12.02, 11.80, 12.48, 13.61, 12.07, 7.60, 7.66, 8.89]
        };

        var chart = new CanvasJS.Chart("chartContainer", {
            theme: "light2",
            animationEnabled: true,
            zoomEnabled: true,
            title: {
                text: "Deviceper Device"
            },
            axisY: {
                title: "Number of Viewers",
                suffix: ""
            },
            legend: {
                cursor: "pointer",
                itemclick: toggleDataSeries
            },
            data: [] 
        });

        
        function updateChart() {
            chart.options.data = [];
            let DeviceCount = Object.keys(initialData).length;
            let StepCount = initialData["Device 1"].length;

            for (let i = 1; i <= DeviceCount; i++) {
                const DeviceData = initialData[`Device ${i}`].map((value, index) => ({
                    label: `Step ${index + 1}`,
                    y: value
                }));

                chart.options.data.push({
                    type: "line",
                    visible: true,
                    showInLegend: true,
                    name: `Device ${i}`,
                    dataPoints: DeviceData
                });
            }

            chart.render();
        }

        
        updateChart();

        const connectionStatus = document.getElementById('connectionStatus');



        const slider = document.getElementById("mainSlider");
        const sliderValue = document.getElementById("sliderValue");
        const StepSelect = document.getElementById("StepSelect");
        const DeviceSelect = document.getElementById("DeviceSelect");
        const addDeviceButton = document.getElementById("addDeviceButton");
        const addStepButton = document.getElementById("addStepButton");

        const socket = new WebSocket(`ws://192.168.1.206/ws`);


        socket.onopen = function(e) {
            connectionStatus.textContent = 'Connected';
            connectionStatus.style.color = 'green';
        };
        socket.onclose = function(event) {
            connectionStatus.textContent = 'Disconnected';
            connectionStatus.style.color = 'red';
        };
        socket.onerror = function(error) {
            console.error('WebSocket Error:', error);
            connectionStatus.textContent = 'Connection Error';
            connectionStatus.style.color = 'red';
        };

        addDeviceButton.addEventListener('click',function(){
            DeviceCount++;
            const option = document.createElement("option");
            option.value = DeviceCount - 1;
            option.text = `Device ${DeviceCount}`;
            DeviceSelect.add(option);
            initialData[`Device ${DeviceCount}`] = Array(StepCount).fill(5);
            updateChart();
        });

        addStepButton.addEventListener('click', function () {
            const StepCount = initialData["Device 1"].length + 1;
            Object.keys(initialData).forEach(Device => {
                initialData[Device].push(5); 
            });
            updateChart();
        });


        slider.oninput = function () {
            const value = parseFloat(this.value);
            sliderValue.textContent = value.toFixed(2);

            const selectedStep = parseInt(StepSelect.value);
            const selectedDevice = parseInt(DeviceSelect.value);

            initialData[`Device ${selectedDevice + 1}`][selectedStep] = value;
            updateChart();
        };

        function toggleDataSeries(e) {
            if (typeof(e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
                e.dataSeries.visible = false;
            } else {
                e.dataSeries.visible = true;
            }
            chart.render();
        }
        slider.onchange = function() {
            const value = parseFloat(this.value);
            const selectedStep = parseInt(StepSelect.value);
            const selectedDevice = parseInt(DeviceSelect.value);

            const msg = JSON.stringify({
                CMD: "get",
                Device: `Device ${selectedDevice + 1}`,
                Step: selectedStep + 1,
                Degree: value.toFixed(2),
                Set_PRM: 20 
            });

            console.log(`Sending Data: ${msg}`);
            socket.send(msg); 
        };
       
        const exportButton = document.getElementById("exportButton");
        exportButton.addEventListener('click', function () {
            const data = Object.keys(initialData).map(Device => ({
                Device: Device,
                Steps: initialData[Device]
            }));

            console.log('Exported Data:');
            data.forEach(DeviceData => {
                console.log(`${DeviceData.Device}:`, DeviceData.Steps);
            });
        });

        };
            </script>
            <script src="https://cdn.canvasjs.com/canvasjs.min.js"></script>
        </body>
        </html> 


